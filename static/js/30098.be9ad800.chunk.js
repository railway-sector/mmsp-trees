"use strict";(self.webpackChunkmmsp_trees=self.webpackChunkmmsp_trees||[]).push([[30098],{30098:(t,e,s)=>{s.r(e),s.d(e,{FeatureTileTree3D:()=>Ut});var i=s(6326),r=s(91967),n=s(19276),o=(s(81806),s(76460)),l=s(30726),a=s(68930),u=s(68134),h=s(75540),c=s(46053),d=(s(47249),s(87990)),f=s(2413),_=s(76191),m=s(20664),p=s(9392),v=s(4763),g=s(95925),y=s(34111),T=s(98510),M=s(45308),S=s(482);var b=s(13927),w=s(61985);class x{constructor(t,e){this._renderCoordsHelper=t,this.opaqueGround=e,this._cache=new Map,this._cameraForward=(0,p.vt)(),this._cameraEye=(0,p.vt)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,p.vt)(),this._frustumBoundingSphereRadius=0,this._frustum=new w.P(t),this._renderSR=t.spatialReference;const s=(0,T.lO)(this._renderSR);this._renderSREllipsoidRadius=(0,y.tO)(s).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),(0,m.n)(this._cameraForward,t.viewForward),(0,m.d)(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);const e=this._isVisibleInFrustum(t);return this._cache.set(t.id,e),e}_isVisibleInFrustum(t){return 2===this._renderCoordsHelper.viewingMode?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){const t=this._frustum,e=t.origin,s=D;(0,m.n)(s,t.direction);const i=t.points,r=V;(0,m.a)(r,i[4],e);const n=.5*(0,m.f)(r,r)/(0,m.f)(s,r),o=this._frustumBoundingSphereCenter;(0,m.c)(o,e,s,n);const l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(t){const e=t.spatialReference,s=t.extent,i=this._renderSR;if(!s)return!0;if(B[0]=s[0],B[1]=s[1],B[2]=0,B[3]=s[2],B[4]=s[3],B[5]=0,!(0,M.projectBuffer)(B,e,0,B,i,0))return!1;(0,m.j)(P[0],B[0],B[1],0),(0,m.j)(P[1],B[3],B[1],0),(0,m.j)(P[2],B[3],B[4],0),(0,m.j)(P[3],B[0],B[4],0),(0,m.j)(k,.5*(B[0]+B[3]),.5*(B[1]+B[4]),.5*(B[2]+B[5]));const r=St,n=.5*(0,m.F)(P[0],P[2]),o=this._frustum,l=this._frustumBoundingSphereRadius,a=this._frustumBoundingSphereCenter,u=z;(0,m.a)(u,a,k);const h=(0,m.f)(r,u),c=Y;if((0,m.c)(c,k,r,h),(0,m.F)(c,a)>n+l)return!1;const d=this._cameraForward,f=(0,m.f)(d,St),_=this._cameraFovY,p=this._cameraEye;if(Math.abs(f)<Math.abs(Math.cos(.5*_))){let t=!0;const e=(0,m.j)(bt,d[0],d[1],0),s=(0,m.f)(p,e);for(let i=0;i<4;++i){const r=P[i];if((0,m.f)(r,e)-s>0){t=!1;break}}if(t)return!1}{const t=P[0],e=P[2];if(t[0]<=p[0]&&p[0]<=e[0]&&t[1]<=p[1]&&p[1]<=e[1])return!0}const v=I,g=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,T=Math.min(y?gt:1/0,h+l),S=Math.max(g?-gt:-1/0,h-l);for(let M=0;M<4;++M)(0,m.c)(v[M],P[M],r,T),(0,m.c)(v[M+4],P[M],r,S);if(F(o.planes,v,8))return!1;if(O(o.planes,v,8))return!0;for(let m=0;m<4;++m){const t=v[m],e=v[m+4];if(wt(o.planes,t,e))return!0;const s=v[(m+1)%4];if(wt(o.planes,t,s))return!0;const i=v[4+(m+1)%4];if(wt(o.planes,e,i))return!0}if(Ct[0][3]=+P[0][0],Ct[1][3]=-P[2][0],Ct[2][3]=+P[0][1],Ct[3][3]=-P[2][1],Ct[4][3]=+S,Ct[5][3]=-T,O(Ct,o.points))return!0;if(O(Ct,o.points))return!0;for(let m=0;m<4;++m){const t=p,e=o.points[m+4];if(xt(Ct,t,e))return!0;const s=o.points[4+(m+1)%4];if(xt(Ct,e,s))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<A)return!0;const e=t.spatialReference,s=t.extent;if(!s||!e)return!0;const i=this.opaqueGround&&this._aboveGround,r=this.opaqueGround&&!this._aboveGround,n=P,o=.5*(s[0]+s[2]);if((0,m.j)(n[0],s[0],s[1],0),(0,m.j)(n[1],s[2],s[1],0),(0,m.j)(n[2],s[2],s[3],0),(0,m.j)(n[3],s[0],s[3],0),(0,m.j)(n[4],o,s[1],0),(0,m.j)(n[5],o,s[3],0),!function(t,e,s,i,r,n){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const l=(0,S.jd)(e,r);if(null==l)return!1;if(l===S.pO){if(t===i&&s===n)return!0;const e=s+o;for(let r=s,o=n;r<e;++r,++o)(0,m.d)(i[o],t[r]);return!0}const a=s+o;for(let u=s,h=n;u<a;++u,++h)l(t[u],0,i[h],0);return!0}(n,e,0,n,this._renderSR,0,6))return!1;const l=n[0][2]>0,a=n[3][2]<0,u=l||a,h=this._renderSREllipsoidRadius;if(u){const t=H;R(t,Et,n[0]);const e=N;if(R(e,Et,n[1]),l){const s=q,i=n[4],r=U;R(r,i,Et),R(s,r,i);const o=n[0];(0,m.i)(o,t,s),E(o,h);const l=n[1];(0,m.i)(l,e,s),E(l,h)}else if(a){const s=q,i=n[5],r=U;R(r,i,Et),R(s,i,r);const o=n[3];(0,m.i)(o,s,t),E(o,h);const l=n[2];(0,m.i)(l,s,e),E(l,h)}}const c=k,d=(0,m.a)(X,n[3],n[0]);(0,m.n)(d,d);const f=(0,m.g)(tt,n[0],n[3]);(0,m.h)(f,f,.5);const _=-(0,m.f)(f,d),v=(0,m.g)(et,n[0],n[1]);(0,m.h)(v,v,.5);const g=(0,m.g)(st,n[2],n[3]);(0,m.h)(g,g,.5);const y=(0,m.a)(it,g,v);(0,m.n)(y,y);const T=-(_+(0,m.f)(d,v))/(0,m.f)(d,y);(0,m.c)(c,v,y,T),E(c,h);const M=this._frustumBoundingSphereRadius,w=this._frustumBoundingSphereCenter,x=this._frustum,L=x.planes,j=Z;(0,m.n)(j,c);const O=(0,m.f)(n[0],j)/(0,m.H)(n[0]),I=x.origin,B=x.points;let D=!1;if(i){{D=!0;const t=(0,m.n)(yt,I);for(let e=0;e<4;++e){const s=B[4+e],i=(0,m.a)((0,p.vt)(),s,I);(0,m.n)(i,i);const r=(0,m.i)((0,p.vt)(),t,i);(0,m.n)(r,r);const n=(0,m.i)((0,p.vt)(),i,r);if((0,m.n)(n,n),(0,m.f)(I,n)>h){D=!1;break}}}if(D&&(0,m.f)(I,j)<h*O-gt)return!1;const t=(0,m.n)(yt,x.origin);if((0,m.f)(t,j)<0)return!1;{const t=(0,m.n)(Tt,x.direction);if((0,m.f)(t,j)>Mt)return!1}}const V=Math.sqrt(1-O*O);if(V>.9)return!0;let Y=!1;const z=(0,m.f)(j,w),at=(0,m.H)(w);if(at<=M&&!L.some(t=>(0,b.mN)(t,$)>0)){if(!i)return!0;Y=!0}const pt=z/at;if(!Y&&z<=0&&-z>M)return!1;const St=M/at;if(Math.sqrt(1-pt*pt)*Math.sqrt(1-St*St)-St*pt>V)return!1;if(!D){if(n.some(t=>x.intersectsPoint(t)))return!0;if(x.intersectsPoint(c))return!0}const bt=J;(0,m.a)(bt,w,$);const wt=(0,m.f)(bt,j),xt=W;(0,m.h)(xt,j,wt);const Rt=(0,m.F)(xt,w),Ct=e.isWGS84,Lt=t.lij,jt=Ct&&Lt[2]===2**Lt[0]-1,Ft=Ct&&0===Lt[2],Ot=Ft?ft:jt?ct:ut,At=Ft?_t:jt?dt:ht;if(!Y){const t=n,e=mt,s=rt,i=nt,r=$;for(const n of Ot){const o=t[n];if(C(s,t[(n+1)%4],o),C(i,r,o),R(e,i,s),G(e,B,1))return!1}}let Gt=null;if(!i&&wt<1.01*M){const t=2.5*M;if(Rt>O*t+M)return!1;const e=Q,s=t/O;for(let i=0;i<4;++i)(0,m.h)(e[i],n[i],s/h);(0,m.j)(e[4],0,0,0),Gt=e}else{const t=(r?h+gt:wt+M)/O,e=i?h-gt:(wt-M)/O,s=K;for(let i=0;i<4;++i){const r=n[i];(0,m.h)(s[i],r,e/h),(0,m.h)(s[i+4],r,t/h)}Gt=s}if(F(L,Gt,Gt.length))return!1;const It=x.lines,Bt=ot,Pt=lt;for(const p of It){(0,m.n)(Pt,p.direction);for(const t of At){const e=Gt[t];if((0,m.n)(Bt,e),vt(Pt,Bt,Gt,B))return!1;const s=(t+1)%4;if(i){const t=Gt[s];if((0,m.a)(Bt,t,e),(0,m.n)(Bt,Bt),vt(Pt,Bt,Gt,B))return!1}if(r){const e=Gt[4+t],i=Gt[4+s];if((0,m.a)(Bt,i,e),(0,m.n)(Bt,Bt),vt(Pt,Bt,Gt,B))return!1}}}return!0}}function R(t,e,s){return(0,m.i)(t,e,s),(0,m.n)(t,t),t}function C(t,e,s){return(0,m.a)(t,e,s),(0,m.n)(t,t),t}function E(t,e){return(0,m.h)(t,t,e/(0,m.H)(t)),t}const L=[0,1,2,3,5];function j(t,e,s){for(let i=0;i<s;++i)if((0,b.mN)(t,e[i])<=0)return!1;return!0}function F(t,e,s){for(const i of L)if(j(t[i],e,s))return!0;return!1}function O(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;for(let i=0;i<s;++i){const s=e[i];let r=!0;for(const e of t)if((0,b.mN)(e,s)>0){r=!1;break}if(r)return!0}return!1}const A=2;function G(t,e,s){for(const i of e)if((0,m.f)(i,t)<s)return!1;return!0}const I=[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()],B=[0,0,0,0,0,0],P=[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()],k=(0,p.vt)(),q=(0,p.vt)(),H=(0,p.vt)(),N=(0,p.vt)(),U=(0,p.vt)(),Z=(0,p.vt)(),W=(0,p.vt)(),D=(0,p.vt)(),V=(0,p.vt)(),Y=(0,p.vt)(),z=(0,p.vt)(),$=(0,p.CN)(0,0,0),J=(0,p.vt)(),K=[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()],Q=[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()],X=(0,p.vt)(),tt=(0,p.vt)(),et=(0,p.vt)(),st=(0,p.vt)(),it=(0,p.vt)(),rt=(0,p.vt)(),nt=(0,p.vt)(),ot=(0,p.vt)(),lt=(0,p.vt)(),at=(0,p.vt)(),ut=[0,1,2,3],ht=[0,1,2,3],ct=[0,1,3],dt=[0,1,3],ft=[1,2,3],_t=[1,2,3],mt=(0,p.vt)();const pt=[0,0];function vt(t,e,s,i){const r=s.length,n=i.length;if(0===r||0===n)return!0;const o=at;R(o,t,e);const l=n<r,a=l?s:i,u=pt;return function(t,e,s){let i=1/0,r=-1/0;for(const n of s){const t=(0,m.f)(e,n);i=Math.min(i,t),r=Math.max(r,t)}t[0]=i,t[1]=r}(u,o,l?i:s),function(t,e,s,i){let r=1/0,n=-1/0;for(const o of i){const i=(0,m.f)(s,o);if(r=Math.min(r,i),n=Math.max(n,i),r<=e&&n>=t)return!1}return!0}(u[0],u[1],o,a)}const gt=430,yt=(0,p.vt)(),Tt=(0,p.vt)(),Mt=Math.cos(.25*Math.PI),St=(0,p.fA)(0,0,1),bt=(0,p.vt)();function wt(t,e,s){const i={t0:0,t1:1};for(const r of L)if(!Rt(t[r],e,s,i))return!1;return i.t0<i.t1}function xt(t,e,s){const i={t0:0,t1:1};for(const r of t)if(!Rt(r,e,s,i))return!1;return i.t0<i.t1}function Rt(t,e,s,i){let{t0:r,t1:n}=i;const o=(0,b.mN)(t,e),l=(0,b.mN)(t,s);if(o>=0&&l>=0)return!1;if(o<0&&l>=0){const t=-o/(l-o);if(t<r)return!1;t<n&&(n=t)}else if(o>=0&&l<0){const t=o/(o-l);if(t>n)return!1;t>r&&(r=t)}return i.t0=r,i.t1=n,!0}const Ct=[(0,b.fA)(-1,0,0,1),(0,b.fA)(1,0,0,-1),(0,b.fA)(0,-1,0,1),(0,b.fA)(0,1,0,-1),(0,b.fA)(0,0,-1,1),(0,b.fA)(0,0,1,-1)],Et=(0,p.CN)(0,0,1);var Lt=s(33062);class jt{constructor(t,e,s){this._renderCoordsHelper=t,this._tilingScheme=e,this._camera=new Lt.A,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new x(t,s)}set opaqueGround(t){this._visibility.opaqueGround=t}setup(t,e,s){this._camera.copyFrom(t),this._surfaceElevation=s,this._focusOnMap[0]=e.x,this._focusOnMap[1]=e.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(t){const{measures:e,extent:s,level:i}=t;s&&(e.visible=this._visibility.compute(t),e.distance=(0,f.Io)(s,this._focusOnMap),e.mergeable=!0,e.lodLevel=A,e.splitPriority=Math.max(0,A-i),e.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(t):this._updateSplitAndLodLocal(t)))}_updateSplitAndLodGlobal(t){const e=t.level,s=this._renderCoordsHelper,{eye:i,fov:r}=this._camera,n=s.referenceEllipsoid.radius,o=(0,m.H)(i)-n;if(2*Math.atan(n/o)<r&&o>0)return void(t.measures.lodLevel=Math.max(e,A));const l=Ft,{extent:a}=t;if(!a)return;const{_surfaceElevation:u}=this;(0,m.j)(l[0],a[0],a[1],u),(0,m.j)(l[1],a[2],a[1],u),(0,m.j)(l[2],a[2],a[3],u),(0,m.j)(l[3],a[0],a[3],u);const h=(0,m.j)(Ot,.5*(a[0]+a[2]),.5*(a[1]+a[3]),u),c=this._tilingScheme.spatialReference;for(let m=0;m<4;++m)s.toRenderCoords(l[m],c,l[m]);s.toRenderCoords(h,c,h);const d=(0,m.n)(Bt.direction,h),f=(0,m.f)(i,d),_=(0,m.h)(Gt,d,f);this._updateSplitAndLod(t,l,h,_)}_updateSplitAndLodLocal(t){const e=Ft,{extent:s}=t;if(!s)return;const{_surfaceElevation:i}=this;(0,m.j)(e[0],s[0],s[1],i),(0,m.j)(e[1],s[2],s[1],i),(0,m.j)(e[2],s[2],s[3],i),(0,m.j)(e[3],s[0],s[3],i);const r=this._tilingScheme.spatialReference;for(let h=0;h<4;++h)this._renderCoordsHelper.toRenderCoords(e[h],r,e[h]);const n=(0,m.j)(Ot,.5*(e[0][0]+e[2][0]),.5*(e[0][1]+e[2][1]),.25*(e[0][2]+e[1][2]+e[2][2]+e[3][2])),o=(0,m.j)(At,n[0],n[1],0),{eye:l,far:a}=this._camera,u=(0,m.j)(Gt,o[0],o[1],l[2]);(0,m.j)(Bt.origin,o[0],o[1],l[2]-2*a),(0,m.d)(Bt.direction,It),this._updateSplitAndLod(t,e,n,u)}_updateSplitAndLod(t,e,s,i){const r=Math.max((0,m.F)(e[0],e[2]),(0,m.F)(e[1],e[3]),(0,m.F)(e[0],s)+(0,m.F)(s,e[2]),(0,m.F)(e[1],s)+(0,m.F)(s,e[3])),{eye:n,near:o,fov:l,viewForward:a,width:u,height:h,pixelRatio:c,frustum:d}=this._camera,f=(0,m.f)(n,a),_=(0,m.f)(s,a)-f,p=(0,m.F)(s,n);let g=_,y=_,T=p,M=p;const S=(t,e)=>e<o?1:Math.sqrt(t*t-e*e)/e;let b=S(p,_);for(const v of e){const t=(0,m.f)(v,a)-f;g=Math.min(g,t),y=Math.max(y,t);const e=(0,m.F)(v,n);M=Math.max(M,e),T=Math.min(T,e);const s=S(e,t);b=Math.min(b,s)}if(y<o)return void(t.measures.lodLevel=0);const w=Math.cos(.5*l),x=(0,m.F)(n,i);b>w&&x>kt*r&&(y=qt*M,g=qt*T);const R=.5*Math.sqrt(u*u+h*h)/c,C=2*Math.tan(.5*l),E=t=>Math.max(o,t)*Pt/R*C,L=t.level,j=r*2**L*Math.max(1,C),F=E(g),O=Math.ceil(Math.log2(Math.max(1,j/F)));if(t.measures.lodLevel=Math.max(O,t.measures.lodLevel),t.measures.splitPriority+=t.measures.lodLevel-L,L<O){const s=+(0,v.bU)(d,e[0])+ +(0,v.bU)(d,e[1])+ +(0,v.bU)(d,e[2])+ +(0,v.bU)(d,e[3]);t.measures.splitPriority+=s}const A=E(y)/F;A>2.5&&(t.measures.splitPriority+=A)}get _isGlobal(){return 1===this._renderCoordsHelper.viewingMode}}const Ft=[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()],Ot=(0,p.vt)(),At=(0,p.vt)(),Gt=(0,p.vt)(),It=(0,p.CN)(0,0,1),Bt=(0,g.fA)(p.uY,It),Pt=312,kt=.5,qt=2;var Ht=s(42136),Nt=s(59752);let Ut=class extends r.A{constructor(t){super(t),this.tiles=new n.A,this.tileSize=512,this._idToTile=new Map,this._dirty=(0,h.v)(!1),this._pendingTiles=(0,h.v)(null),this._newTiles=new a.A,this._tests=!1,this._measurements=new jt(t.renderCoordsHelper,t.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([(0,u.wB)(()=>this.tileSize,()=>this._reset(),u.pc),(0,u.wB)(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),u.pc),(0,u.wB)(()=>this.tilingScheme,t=>{this._reset(),this._measurements=new jt(this.renderCoordsHelper,t,this._opaqueGround)},u.OH),(0,u.wB)(()=>this._opaqueGround,t=>this._measurements.opaqueGround=t,u.OH)]),this._frameWorker=this.scheduler?.registerTask(Nt.W6.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,l.xt)(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(t){if(null!=t&&!t.spatialReference.equals(this.viewState.spatialReference))return void o.A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const e=this._get("filterExtent");if(e===t||null!=e&&t&&e.equals(t))return;const s=null!=t?t.clone():null;this._set("filterExtent",s),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const t=(0,f.vt)();return(0,Ht.k)(this.filterExtent,t,this.tilingScheme.spatialReference),t}get _rootTileIds(){const{tilingScheme:t}=this;return this._filterExtentRect&&t?t.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(Nt.Bb))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._newTiles.clear(),this._pendingTiles.value=null,t&&this._setDirty()}_getRootTiles(){const t=this.tilingScheme;return this._rootTileIds.map(e=>new _.mS(e[0],e[1],e[2],t))}runTask(t){t=this._tests?Nt.Bb:t,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(t),null!=this._frameWorker&&(this._frameWorker.priority=Nt.W6.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(t),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=Nt.W6.FEATURE_TILE_TREE)}_startUpdate(t){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:e,_filterExtentRect:s,_newTiles:i}=this;e.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(t=>{if(e.update(t),t.measures.visible&&(!s||!t.extent||(0,f.HY)(t.extent,s))){if(t.measures.splitPriority>0)return!0;i.push(t)}return!1}).sort(Zt),this._newTiles.clear(),t.madeProgress()}_splitPendingTiles(t){const e=this._pendingTiles.value;if(!e)return;const{tilingScheme:s,_filterExtentRect:i,_newTiles:r,_measurements:n}=this;for(;e.length>0&&this._tileBudgetRatio<=2;){const o=e.pop();if(t.madeProgress(),o.measures.splitPriority>0){s.ensureMaxLod(o.level+1);const t=o.createChildren();for(const s of t)n.update(s),!s.measures.visible||i&&s.extent&&!(0,f.HY)(s.extent,i)||(s.measures.splitPriority>0?e.push(s):r.push(s));e.sort(Zt),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else r.push(o);if(t.done)return}r.pushArray(e),this._pendingTiles.value=null,this._updateTiles(),r.clear(),n.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._tileBudgetRatio<=t)return;const{_newTiles:s,_measurements:i}=this;s.sort((t,e)=>e.measures.distance-t.measures.distance);const r=new Map(s.map(t=>[t.id,t])),n=s.length;for(const o of r.values()){const{lij:n,measures:l}=o;if(!l.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||o.lodLevelDelta>=4)continue;const a=l.lodLevel;let u=a,h=!0;const c=r.get((0,_.et)(n[0],n[1]+1,n[2]));let d=Math.abs((c?.measures.lodLevel??0)-a),f=0===d||e&&c?.measures.mergeable&&d<=1;if(!c||!f)continue;u+=c.measures.lodLevel,h&&=0===d;const m=r.get((0,_.et)(n[0],n[1],n[2]+1));if(d=Math.abs((m?.measures.lodLevel??0)-a),f=0===d||e&&m?.measures.mergeable&&d<=1,!m||!f)continue;u+=m.measures.lodLevel,h&&=0===d;const p=r.get((0,_.et)(n[0],n[1]+1,n[2]+1));if(d=Math.abs((p?.measures.lodLevel??0)-a),f=0===d||e&&p?.measures.mergeable&&d<=1,!p||!f)continue;u+=p.measures.lodLevel,h&&=0===d,s.removeUnordered(o),s.removeUnordered(c),s.removeUnordered(m),s.removeUnordered(p),r.delete(o.id),r.delete(c.id),r.delete(m.id),r.delete(p.id);const v=new _.mS(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(i.update(v),v.measures.visible=!0,v.measures.lodLevel=u/4,v.measures.mergeable=h,s.push(v),r.set(v.id,v),this._tileBudgetRatio<=t)return}s.length<n&&this._mergeNewTiles(t,e)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const i of this.tiles.items)i.used=!1;let t=!1;const e=this._newTiles.filter(e=>{const s=this._idToTile.get(e.id);return s?(t||=s.measures.lodLevel!==e.measures.lodLevel,s.measures={...e.measures},s.used=!0):this._idToTile.set(e.id,e),!s}),s=this.tiles.items.filter(t=>!t.used&&(this._idToTile.delete(t.id),!0));this.tiles.removeMany(s),this.tiles.addMany(e),this._sortTiles(),!t||s.length||e.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,e)=>t.measures.distance-e.measures.distance),this.tiles.forEach((t,e)=>t.loadPriority=e)}};function Zt(t,e){return t.lodLevelDelta-e.lodLevelDelta||t.measures.splitPriority-e.measures.splitPriority||e.measures.distance-t.measures.distance}(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ut.prototype,"scheduler",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ut.prototype,"renderCoordsHelper",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ut.prototype,"pointsOfInterest",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ut.prototype,"viewState",void 0),(0,i.Cg)([(0,c.MZ)({constructOnly:!0})],Ut.prototype,"terrain",void 0),(0,i.Cg)([(0,c.MZ)()],Ut.prototype,"tiles",void 0),(0,i.Cg)([(0,c.MZ)()],Ut.prototype,"tileSize",void 0),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ut.prototype,"tilingScheme",null),(0,i.Cg)([(0,c.MZ)()],Ut.prototype,"filterExtent",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ut.prototype,"_filterExtentRect",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ut.prototype,"_rootTileIds",null),(0,i.Cg)([(0,c.MZ)({value:!1})],Ut.prototype,"suspended",null),(0,i.Cg)([(0,c.MZ)({readOnly:!0})],Ut.prototype,"updating",null),Ut=(0,i.Cg)([(0,d.$)("esri.views.3d.layers.support.FeatureTileTree3D")],Ut)},76191:(t,e,s)=>{s.d(e,{Tb:()=>n,et:()=>u,mS:()=>l,nx:()=>o});var i=s(34111),r=s(2413);const n="virtual-snapshot-tile",o="virtual-display-filter-highlight-tile";class l{constructor(t,e,s,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:u(t,e,s);this._tilingScheme=i,this.id=n,this.lij=[0,0,0],this.extent=null,this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=t,this.lij[1]=e,this.lij[2]=s,i&&(this.extent=(0,r.vt)(),i?.getExtent(t,e,s,this.extent))}get planetRadius(){return(0,i.tO)(this.spatialReference).radius}get spatialReference(){return this._tilingScheme?.spatialReference}get resolution(){return this._tilingScheme?.resolutionAtLevel(this.measures.lodLevel)??0}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const t=this.lij[0]+1,e=2*this.lij[1],s=2*this.lij[2];return[new l(t,e,s,this._tilingScheme),new l(t,e+1,s,this._tilingScheme),new l(t,e,s+1,this._tilingScheme),new l(t,e+1,s+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function u(t,e,s){return`${t}/${e}/${s}`}}}]);
//# sourceMappingURL=30098.be9ad800.chunk.js.map